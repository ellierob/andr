(function(q,l){"function"==typeof define&&define.amd?define(["./rangy-core"],q):"undefined"!=typeof module&&"object"==typeof exports?module.exports=q(require("rangy")):q(l.rangy)})(function(q){q.createModule("Highlighter",["ClassApplier"],function(l,K){function B(a,b){return a.characterRange.start==b.characterRange.start?b.characterRange.end-a.characterRange.end:a.characterRange.start-b.characterRange.start}function u(a,b){this.type=a;this.converterCreator=b}function C(a,b){D[a]=new u(a,b)}function n(a,
b){this.start=a;this.end=b}function r(a,b,c,e,d,h,m){d?(this.id=d,v=Math.max(v,d+1)):this.id=v++;this.characterRange=b;this.doc=a;this.className=c;this.converter=e;this.containerElementId=h||null;this.strText=null;this.strNote=m;this.applied=!1}function w(a,b,c){c=c||"textContent";this.doc=b||document;this.classApplier=q.createClassApplier("",a);this.highlights=[];a=c;b=D[a];if(b instanceof u)a=b.create();else throw Error("Highlighter type '"+a+"' is not valid");this.converter=a}var E=l.dom,F=E.arrayContains,
G=E.getBody,H=l.util.createOptions,x=l.util.forEach,v=1,D={};u.prototype.create=function(){var a=this.converterCreator();a.type=this.type;return a};l.registerHighlighterType=C;n.prototype={intersects:function(a){return this.start<a.end&&this.end>a.start},equals:function(a){return this.start===a.start&&this.end===a.end},isContiguousWith:function(a){return this.start==a.end||this.end==a.start},union:function(a){return new n(Math.min(this.start,a.start),Math.max(this.end,a.end))},intersection:function(a){return new n(Math.max(this.start,
a.start),Math.min(this.end,a.end))},getComplements:function(a){var b=[];if(this.start>=a.start){if(this.end<=a.end)return[];b.push(new n(a.end,this.end))}else b.push(new n(this.start,Math.min(this.end,a.start))),this.end>a.end&&b.push(new n(a.end,this.end));return b},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}};n.fromCharacterRange=function(a){return new n(a.start,a.end)};var J={rangeToCharacterRange:function(a,b){var c=a.getBookmark(b);return new n(c.start,c.end)},
characterRangeToRange:function(a,b,c){a=l.createRange(a);a.moveToBookmark({start:b.start,end:b.end,containerNode:c});return a},serializeSelection:function(a,b){for(var c=a.getAllRanges(),e=[],d=1==c.length&&a.isBackward(),h=0,m=c.length;h<m;++h)e[h]={characterRange:this.rangeToCharacterRange(c[h],b),backward:d};return e},restoreSelection:function(a,b,c){a.removeAllRanges();for(var e=a.win.document,d=0,h=b.length,m,g;d<h;++d)g=b[d],m=this.characterRangeToRange(e,g.characterRange,c),a.addRange(m,g.backward)}};
C("textContent",function(){return J});r.prototype={getContainerElement:function(){var a=this.doc,b=this.containerElementId;return b?a.getElementById(b):G(a)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(a){this.characterRange=this.converter.rangeToCharacterRange(a,this.getContainerElement())},getText:function(){null==this.strText&&(this.strText=this.getRange().toString().replace(/\n\s*\n/g,"\n"));return this.strText},
containsElement:function(a){return this.getRange().containsNodeContents(a.firstChild)},getNote:function(){return this.strNote},toString:function(){return"[Highlight ID: "+this.id+", class: "+this.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+', note: "'+this.strNote+'"]'}};w.prototype={getHighlightsForElement:function(a){for(var b=!1,c=[],e=this.highlights,d=e.length-1;0<=d;d--)if(e[d].containsElement(a))c.push(e[d]),b=!0;else if(b)break;return c},getHighlightElements:function(a){this.classApplier.setClassName(a.className);
return this.classApplier.getElementsWithClassIntersectingRange(a.getRange())},unapply:function(a){if(a.strNote){a.hasOwnProperty("jqNoteMark")&&(a.jqNoteMark.remove(),delete a.jqNoteMark);var b=this.getHighlightElements(a);delete b[b.length-1].dataset.rslnote}this.classApplier.setClassName(a.className);this.classApplier.undoToRange(a.getRange());a.applied=!1},apply:function(a){this.classApplier.setClassName(a.className);this.classApplier.applyToRange(a.getRange());for(var b=this.getHighlightElements(a),
c=0;c<b.length;c++)b[c].addEventListener("click",onClickHighlightElement);a.strNote&&(b[b.length-1].dataset.rslnote="("+a.strNote+")");a.applied=!0},removeHighlights:function(a){for(var b=0,c=this.highlights.length,e;b<c;++b)e=this.highlights[b],F(a,e)&&(this.unapply(e),this.highlights.splice(b--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(a){var b=[],c=this.highlights;x(a,function(e){x(c,function(d){e.intersectsRange(d.getRange())&&
!F(b,d)&&b.push(d)})});return b},highlightCharacterRange:function(a,b,c){var e,d=this.highlights,h=this.converter,m=this.doc,g=[];c=H(c,{containerElementId:null});c=c.containerElementId;var f;if(c&&(f=this.doc.getElementById(c))){var p=l.createRange(this.doc);p.selectNodeContents(f);var k=new n(0,p.toString().length)}var y;f=[];p="";var z=null;k&&(b=b.intersection(k));if(b.start==b.end)return[];var t=b;for(k=0;k<d.length;++k){var I=!1;if(c==d[k].containerElementId){var A=d[k].characterRange;if((y=
a==d[k].className)&&A.intersects(t)||!y&&A.equals(b))p?d[k].getNote()&&(p=d[k].getNote()+"\n"+p):p=d[k].getNote(),z||(z=d[k].id),I=!0,y&&(t=A.union(t))}I?g.push(d[k]):f.push(d[k])}a=new r(m,t,a,h,z,c,p);f.push(a);this.highlights=d=f;d.sort(B);for(e in g)this.unapply(g[e]);for(e in d)g=d[e],g.characterRange.intersects(b)&&(b=b.union(g.characterRange),g.applied&&this.unapply(g),this.apply(g));return a},highlightRange:function(a,b,c){var e=this.converter;c=H(c,{containerElement:null});var d=c.containerElement;
c=d?d.id:null;if(d){var h=l.createRange(d);h.selectNodeContents(d)}h=d?h.intersection(b):b;b=e.rangeToCharacterRange(h,d||G(b.getDocument()));return this.highlightCharacterRange(a,b,{containerElementId:c})},unhighlightSelection:function(a){a=a||l.getSelection(this.doc);var b=this.getIntersectingHighlights(a.getAllRanges());this.removeHighlights(b);a.removeAllRanges();return b},getHighlightsInSelection:function(a){a=a||l.getSelection(this.doc);return this.getIntersectingHighlights(a.getAllRanges())},
selectionOverlapsHighlight:function(a){return 0<this.getHighlightsInSelection(a).length},serialize:function(){var a=[];x(this.highlights,function(b){b=[b.characterRange.start,b.characterRange.end,b.id,b.className,b.containerElementId,b.getText(),b.getNote()];a.push(b)});return JSON.stringify(a)},deserialize:function(a){for(var b=[],c=!1,e,d,h,m=0,g=0,f;g<a.length;g++)f=a[g],d=f[4]||null,e=new r(this.doc,new n(f[0],f[1]),f[3],this.converter,f[2],d,f[6]),(h=e.getText())&&h===f[5]?(b.push(e),m=f[0]):
(e=f[5],c=document.body.textContent.indexOf(e,Math.min(m,f[0]-50)),-1===c&&(e=e.replace(/[\u200B-\u200D\uFEFF]/g,""),c=document.body.textContent.indexOf(e,Math.min(m,f[0]-50))),-1!==c&&50>c-f[0]&&(e=new r(this.doc,new n(c,c+e.length),f[3],this.converter,f[2],d,f[6]),b.push(e),m=c),c=!0);b.sort(B);for(g in b)this.apply(b[g]);this.highlights=b;return c}};l.Highlighter=w;l.createHighlighter=function(a,b,c){return new w(a,b,c)}});return q},this);